# bu araÃ§ @PyrusDrago tarafÄ±ndan yazÄ±lmÄ±ÅŸtÄ±r...
name: Readme OluÅŸturucu

on:
  schedule:
    - cron: '0 20 * * *'  # Her gÃ¼n 20:00'de Ã§alÄ±ÅŸÄ±r
  workflow_dispatch:       # Manuel Ã§alÄ±ÅŸtÄ±rma

jobs:
  build-readme:
    name: README DosyasÄ± OluÅŸtur ve GÃ¼ncelle
    runs-on: ubuntu-latest

    steps:
      - name: Depoyu Klonla
        uses: actions/checkout@v4

      - name: Python OrtamÄ±nÄ± Kur
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: README.md DosyasÄ±nÄ± OluÅŸtur
        run: |
          import json
          from datetime import datetime, timedelta, timezone
          from pathlib import Path

          OWNER = "PyrusDrago"
          OWNER_AVATAR = "https://github.com/TRplugins.png"
          OWNER_PROFILE = "https://github.com/TRplugins"
          REPO_SHORT_CODE = "TRplugins"

          IMAGE_KEYS = ["iconUrl", "image", "icon", "logo", "thumbnail", "cover", "img", "picture", "poster"]
          LANGUAGE_FLAGS = {
              "af": ("ğŸ‡¿ğŸ‡¦", "ZA"), "az": ("ğŸ‡¦ğŸ‡¿", "AZ"), "id": ("ğŸ‡®ğŸ‡©", "ID"), "ms": ("ğŸ‡²ğŸ‡¾", "MY"),
              "de": ("ğŸ‡©ğŸ‡ª", "DE"), "en": ("ğŸ‡¬ğŸ‡§", "GB"), "es": ("ğŸ‡ªğŸ‡¸", "ES"), "eo": ("ğŸ³ï¸â€ğŸŒˆ", "EO"),
              "fil": ("ğŸ‡µğŸ‡­", "PH"), "fr": ("ğŸ‡«ğŸ‡·", "FR"), "gl": ("ğŸ‡ªğŸ‡¸", "ES"), "hr": ("ğŸ‡­ğŸ‡·", "HR"),
              "it": ("ğŸ‡®ğŸ‡¹", "IT"), "lv": ("ğŸ‡±ğŸ‡»", "LV"), "lt": ("ğŸ‡±ğŸ‡¹", "LT"), "hu": ("ğŸ‡­ğŸ‡º", "HU"),
              "mt": ("ğŸ‡²ğŸ‡¹", "MT"), "nl": ("ğŸ‡³ğŸ‡±", "NL"), "no": ("ğŸ‡³ğŸ‡´", "NO"), "pl": ("ğŸ‡µğŸ‡±", "PL"),
              "pt": ("ğŸ‡µğŸ‡¹", "PT"), "pt-br": ("ğŸ‡§ğŸ‡·", "BR"), "ro": ("ğŸ‡·ğŸ‡´", "RO"), "sk": ("ğŸ‡¸ğŸ‡°", "SK"),
              "so": ("ğŸ‡¸ğŸ‡´", "SO"), "sv": ("ğŸ‡¸ğŸ‡ª", "SE"), "tl": ("ğŸ‡µğŸ‡­", "PH"), "vi": ("ğŸ‡»ğŸ‡³", "VN"),
              "tr": ("ğŸ‡¹ğŸ‡·", "TR"), "cs": ("ğŸ‡¨ğŸ‡¿", "CZ"), "el": ("ğŸ‡¬ğŸ‡·", "GR"), "bg": ("ğŸ‡§ğŸ‡¬", "BG"),
              "mk": ("ğŸ‡²ğŸ‡°", "MK"), "ru": ("ğŸ‡·ğŸ‡º", "RU"), "uk": ("ğŸ‡ºğŸ‡¦", "UA"), "he": ("ğŸ‡®ğŸ‡±", "IL"),
              "ur": ("ğŸ‡µğŸ‡°", "PK"), "ar": ("ğŸ‡¦ğŸ‡ª", "AE"), "ar-sa": ("ğŸ‡¸ğŸ‡¦", "SA"), "ar-ly": ("ğŸ‡±ğŸ‡¾", "LY"),
              "fa": ("ğŸ‡®ğŸ‡·", "IR"), "ne": ("ğŸ‡³ğŸ‡µ", "NP"), "in": ("ğŸ‡®ğŸ‡³", "IN"), "bn": ("ğŸ‡§ğŸ‡©", "BD"),
              "my": ("ğŸ‡²ğŸ‡²", "MM"), "am": ("ğŸ‡ªğŸ‡¹", "ET"), "ti": ("ğŸ‡ªğŸ‡¹", "ET"), "om": ("ğŸ‡ªğŸ‡¹", "ET"),
              "zh": ("ğŸ‡¨ğŸ‡³", "CN"), "ja": ("ğŸ‡¯ğŸ‡µ", "JP"), "zh-tw": ("ğŸ‡¹ğŸ‡¼", "TW"), "ko": ("ğŸ‡°ğŸ‡·", "KR")
          }
          INDIA_LANGS = {"hi", "as", "or", "ta", "kn", "ml"}
          DEFAULT_FLAG = ("ğŸ´â€â˜ ï¸", "")

          def fix_icon_url(url):
              if url and "%size%" in url:
                  return url.replace("%size%", "64")
              return url

          def turkish_types(tvtypes):
              if not tvtypes or not isinstance(tvtypes, list):
                  return ["Bilinmiyor"]
              types = []
              for t in tvtypes:
                  for subt in str(t).split(","):
                      st = subt.strip().lower()
                      types.append({
                          "movie": "Film",
                          "animemovie": "Anime Filmi",
                          "tvseries": "Dizi",
                          "cartoon": "Ã‡izgi Film",
                          "anime": "Anime",
                          "ova": "OVA (Anime)",
                          "torrent": "Torrent",
                          "documentary": "Belgesel",
                          "asiandrama": "Asya Dizisi",
                          "live": "CanlÄ± TV",
                          "others": "DiÄŸer",
                          "music": "MÃ¼zik",
                          "audiobook": "Sesli Kitap",
                          "custommedia": "Ã–zel Medya",
                          "audio": "Ses",
                          "podcast": "Podcast"
                      }.get(st, st.capitalize() if st else "Bilinmiyor"))
              return list(dict.fromkeys(types))

          def get_flag_and_code(language):
              language = (language or "").lower().strip().replace("_", "-")
              base = language.split("-")[0]
              if base in INDIA_LANGS:
                  return LANGUAGE_FLAGS["in"]
              return LANGUAGE_FLAGS.get(language) or LANGUAGE_FLAGS.get(base) or DEFAULT_FLAG

          turkey_tz = timezone(timedelta(hours=3))
          formatted_date = datetime.now(turkey_tz).strftime("%d.%m.%Y %H:%M")

          with open("plugins.json", encoding="utf-8") as f:
              plugins = json.load(f)

          unique_plugins = {}
          for plugin in plugins:
              name = (plugin.get("name") or plugin.get("title") or str(plugin)).strip()
              if not name or name in unique_plugins:
                  continue
              language = (plugin.get("language") or "").lower().strip()
              flag, code = get_flag_and_code(language)
              img_url = next((fix_icon_url(plugin[key]) for key in IMAGE_KEYS if plugin.get(key)), None)
              tur_types = turkish_types(plugin.get("tvTypes"))
              unique_plugins[name] = (img_url, tur_types, flag, code)

          plugin_count = len(unique_plugins)
          readme_header = (
              f"### Son GÃ¼ncelleme: {formatted_date}\n\n"
              f"### Repo KÄ±sa Kodu: {REPO_SHORT_CODE}\n\n"
              f"### Toplam Eklenti SayÄ±sÄ±: {plugin_count}\n\n"
              "---\n\n"
              f"### Depo Sahibi:\n"
              f"[<img src='{USER_AVATAR}' width='48' height='48' style='border-radius:50%;'>]({USER_PROFILE})  \n"
              f"[{OWNER}]({USER_PROFILE})\n"
              "---\n\n"
              "## ğŸ“¦ Eklenti Listesi\n\n"
              "| Ä°kon | Eklenti AdÄ± | TÃ¼rler | Ãœlke |\n"
              "|:----:|:------------|:-------|:----:|\n"
          )

          table_rows = []
          for name, (img_url, tur_types, flag, code) in sorted(unique_plugins.items()):
              tur_text = ", ".join(tur_types)
              img_md = f'<img src="{img_url}" width="32" style="vertical-align:middle;">' if img_url else "â€”"
              country_col = f"{flag} [{code}]" if flag and code else DEFAULT_FLAG[0]
              table_rows.append(f"| {img_md} | **{name}** | {tur_text} | {country_col} |")

          readme_content = readme_header + "\n".join(table_rows)
          Path("README.md").write_text(readme_content, encoding="utf-8")
        shell: python

      - name: README.md DosyasÄ±nÄ± Commit ve Push Et
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "Docs: README.md dosyasÄ± gÃ¼ncellendi"
            git push
          else
            echo "README.md dosyasÄ±nda deÄŸiÅŸiklik tespit edilmedi."
          fi
