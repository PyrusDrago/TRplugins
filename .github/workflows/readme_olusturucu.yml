# bu araç @PyrusDrago tarafından yazılmıştır...
name: Readme Oluşturucu

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:

jobs:
  build-readme:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Python Ortamını Kur
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: README.md Dosyasını Oluştur
        run: |
          import json
          from datetime import datetime, timedelta, timezone
          from pathlib import Path

          SAHIP = "PyrusDrago"
          SAHIP_RESIM = "https://github.com/TRplugins.png"
          SAHIP_PROFIL = "https://github.com/TRplugins"
          REPO_KISA_KODU = "TRplugins"

          GORSEL_ANAHTARLARI = ["iconUrl", "image", "icon", "logo", "thumbnail", "cover", "img", "picture", "poster"]
          DIL_BAYRAKLARI = {
              "tr": ("🇹🇷", "TR"), "en": ("🇬🇧", "GB"), "de": ("🇩🇪", "DE"), "fr": ("🇫🇷", "FR"),
              "es": ("🇪🇸", "ES"), "it": ("🇮🇹", "IT"), "ru": ("🇷🇺", "RU"), "zh": ("🇨🇳", "CN"),
              "ja": ("🇯🇵", "JP"), "ko": ("🇰🇷", "KR"), "pt": ("🇵🇹", "PT"), "pt-br": ("🇧🇷", "BR"),
              "ar": ("🇦🇪", "AE")
          }
          VARSAYILAN_BAYRAK = ("🏴‍☠️", "")

          TURKCE_TIPLER = {
              "movie": "Film", "animemovie": "Anime Filmi", "tvseries": "Dizi", "cartoon": "Çizgi Film",
              "anime": "Anime", "ova": "OVA (Anime)", "torrent": "Torrent", "documentary": "Belgesel",
              "asiandrama": "Asya Dizisi", "live": "Canlı TV", "others": "Diğer", "music": "Müzik",
              "audiobook": "Sesli Kitap", "custommedia": "Özel Medya", "audio": "Ses", "podcast": "Podcast"
          }

          def bayrak_kodu(dil):
              dil = (dil or "").lower().strip().replace("_", "-")
              return DIL_BAYRAKLARI.get(dil, VARSAYILAN_BAYRAK)

          def tipleri_cevir(tvtypes):
              if not isinstance(tvtypes, list):
                  return ["Bilinmiyor"]
              sonuc = []
              for t in tvtypes:
                  for alt in str(t).split(","):
                      alt = alt.strip().lower()
                      sonuc.append(TURKCE_TIPLER.get(alt, alt.capitalize()))
              return list(dict.fromkeys(sonuc))

          def gorsel_url(plugin):
              for anahtar in GORSEL_ANAHTARLARI:
                  if plugin.get(anahtar):
                      return plugin[anahtar].replace("%size%", "64")
              return None

          turkiye_saati = timezone(timedelta(hours=3))
          tarih = datetime.now(turkiye_saati).strftime("%d.%m.%Y %H:%M")

          with open("plugins.json", encoding="utf-8") as f:
              eklentiler = json.load(f)

          benzersiz = {}
          for e in eklentiler:
              ad = (e.get("name") or e.get("title") or "").strip()
              if not ad or ad in benzersiz:
                  continue
              bayrak, kod = bayrak_kodu(e.get("language"))
              resim = gorsel_url(e)
              turler = tipleri_cevir(e.get("tvTypes"))
              benzersiz[ad] = (resim, turler, bayrak, kod)

          satirlar = []
          for ad, (resim, turler, bayrak, kod) in sorted(benzersiz.items()):
              ikon = f'<img src="{resim}" width="32" style="vertical-align:middle;">' if resim else "—"
              tur_text = ", ".join(turler)
              ulke = f"{bayrak} [{kod}]" if kod else bayrak
              satirlar.append(f"| {ikon} | **{ad}** | {tur_text} | {ulke} |")

          govde = (
              f"### Son Güncelleme: {tarih}\n\n"
              f"### Depo Kodu: {REPO_KISA_KODU}\n\n"
              f"### Toplam Eklenti Sayısı: {len(benzersiz)}\n\n"
              "---\n\n"
              "### Geliştirici:\n"
              f"[<img src='{SAHIP_RESIM}' width='48' height='48' style='border-radius:50%;'>]({SAHIP_PROFIL})  \n"
              f"[{SAHIP}]({SAHIP_PROFIL})\n"
              "---\n\n"
              "## 📦 Eklenti Listesi\n\n"
              "| İkon | Eklenti Adı | Türler | Ülke |\n"
              "|:----:|:------------|:---------|:-----:|\n"
              + "\n".join(satirlar)
          )

          Path("README.md").write_text(govde, encoding="utf-8")
        shell: python

      - name: README.md Değişikliklerini Gönder
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          if ! git diff --staged --quiet; then
            git commit -m "📝 README.md eklenti listesiyle güncellendi"
            git push
          else
            echo "Değişiklik yok, commit atılmadı."
          fi
